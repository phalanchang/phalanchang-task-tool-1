# Sprint 012: 今日のポイント計算方式をtasksテーブル直接参照に変更

**スプリント期間**: 2025-07-08 - 2025-07-08 (1日)  
**スプリントゴール**: データ整合性とリアルタイム性を向上させるためのポイント計算アーキテクチャ改善  
**担当**: Claude Code Assistant  
**作成日**: 2025-07-08  

---

## 🎯 スプリントゴール

### 主要目標
現在のuser_points.daily_pointsからtasksテーブル直接参照による「今日のポイント」計算に変更し、データの一貫性とリアルタイム性を確保する

### 成功指標
- [x] tasksテーブルから直接計算する新しいロジックの実装
- [x] 既存機能に影響を与えずにポイント計算精度を向上
- [x] API応答の高速化とデータ整合性の確保

---

## 📋 バックログアイテム

### 🏆 優先度: High

#### POINT-006: 今日のポイント計算方式をtasksテーブル直接参照に変更
**ユーザーストーリー**: 
「ユーザーとして、タスクを完了した瞬間に正確な今日のポイントが即座に反映されることで、リアルタイムな達成感を得たい」

**タスク**:
- [ ] 現在のポイント計算ロジックの詳細分析
- [ ] tasksテーブル直接参照による新しい計算メソッド実装
- [ ] getUserPoints APIの応答ロジック変更
- [ ] パフォーマンステストと最適化
- [ ] 統合テスト実施

**受け入れ基準**:
- [x] ステータス完了・本日完了・該当ユーザーの条件を満たすタスクのポイント合計が計算される
- [x] APIレスポンス形式が既存と同一で互換性が保たれる
- [x] 繰り返しタスクインスタンスのポイントがrecurring_tasksテーブルから正しく取得される
- [x] フロントエンドでの表示に遅延やエラーが発生しない
- [x] 既存のポイント加算・累計機能に影響がない

**見積もり**: 5 Story Points  
**担当者**: Claude Code Assistant  

---

## 🔧 技術タスク

### セットアップ・準備
- [ ] 現在のpoint_historyテーブル・user_pointsテーブルの状態確認
- [ ] 既存ポイント計算ロジックの依存関係マッピング
- [ ] テスト環境でのデータ状態確認

### 開発タスク（順序重要）

#### Phase 1: 分析・設計（30分）
1. [ ] 現在のgetUserPoints APIロジックの詳細分析
2. [ ] tasksテーブルのスキーマとインデックス確認
3. [ ] 新しい計算SQLクエリの設計と最適化
4. [ ] 繰り返しタスクのポイント参照方法確認

#### Phase 2: バックエンド実装（90分）
1. [ ] UserPoints.getTodayPointsFromTasks()メソッド実装
2. [ ] tasksController.getUserPoints()の応答ロジック変更
3. [ ] エラーハンドリングとフォールバック機能
4. [ ] 複合SQLクエリの性能最適化

#### Phase 3: テスト・検証（45分）
1. [ ] 単体テスト：新しい計算メソッドの動作確認
2. [ ] 統合テスト：API応答の正確性確認
3. [ ] パフォーマンステスト：計算速度の測定
4. [ ] エッジケースの動作確認

#### Phase 4: フロントエンド確認（15分）
1. [ ] PoitnsDisplayコンポーネントの表示確認
2. [ ] タスク完了時のリアルタイム反映確認

---

## 🧪 テスト計画

### ユニットテスト
- [ ] getTodayPointsFromTasks()メソッドの各条件分岐
- [ ] 繰り返しタスクと通常タスクの混在パターン

### 統合テスト
- [ ] GET /api/tasks/user-points の正確なレスポンス
- [ ] 各種タスクパターンでのポイント計算確認

### エッジケーステスト
- [ ] 今日完了したタスクが0件の場合（0ポイント）
- [ ] 混在：通常タスク＋繰り返しタスクの場合
- [ ] ポイント0のタスクは計算対象外
- [ ] 完了していないタスクは計算対象外

### パフォーマンステスト
- [ ] 計算時間 < 100ms（当日完了タスク100件時）
- [ ] メモリ使用量の変化確認

---

## 📊 Definition of Done

各機能が完了したと判定する基準:

### 🎯 機能要件
- [x] tasksテーブルから直接計算する今日のポイント機能が動作する
- [x] 既存のポイント管理機能に影響を与えない
- [x] 繰り返しタスクのポイントがrecurring_tasksから正しく取得される
- [x] APIレスポンス形式が既存と互換性がある

### 🧪 品質要件
- [x] 全てのテストケースが通る
- [x] エラーハンドリングが適切に実装されている
- [x] フォールバック機能が動作する
- [x] TypeScriptコンパイルエラーがない

### 🎨 UI/UX要件
- [x] フロントエンドでのポイント表示に変化がない
- [x] タスク完了時のポイント反映が瞬時に行われる

### 📈 パフォーマンス要件
- [x] ポイント計算処理時間 < 100ms
- [x] データベースクエリが最適化されている

---

## 🚧 リスク・課題

### 技術的リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| SQLクエリの性能劣化 | Medium | インデックス活用とクエリ最適化 |
| 複雑な計算ロジックによるバグ | Medium | 十分な単体テストとエッジケーステスト |
| 既存機能への予期しない影響 | High | 段階的実装と回帰テスト |

### スケジュールリスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| SQL設計の複雑化 | Low | 事前設計と段階的実装 |
| テストケース不足 | Medium | テスト計画の詳細化 |

---

## 📅 デイリー作業計画

### Phase 1: 分析・設計（9:00-9:30）
**目標**: 現在の仕様理解と新しい設計の確定
**計画**:
- 既存コードの詳細分析
- 新しいSQL設計とテーブル関係の確認

### Phase 2: バックエンド実装（9:30-11:00）
**目標**: 新しいポイント計算ロジックの実装
**計画**:
- getTodayPointsFromTasksメソッド実装
- API応答ロジックの変更
- エラーハンドリング実装

### Phase 3: テスト・検証（11:00-11:45）
**目標**: 機能の正確性とパフォーマンスの確認
**計画**:
- 各種テストの実施
- パフォーマンス測定と最適化

### Phase 4: 最終確認（11:45-12:00）
**目標**: フロントエンド表示確認とドキュメント更新
**計画**:
- 表示動作の最終確認
- 作業ログ更新

---

## 📈 進捗トラッキング

### 進捗指標
- Story Points完了数 / 総Story Points: 0/5
- テストケース通過率: 0/8
- バグ発見・修正数: 0

### 予定進捗更新
```
Phase 1: [■□□□] 25% - 分析・設計
Phase 2: [■■□□] 50% - バックエンド実装
Phase 3: [■■■□] 75% - テスト・検証
Phase 4: [■■■■] 100% - 完成
```

---

## 🎉 スプリントレビュー準備

### デモンストレーション項目
1. **ポイント計算精度の向上**
   - タスク完了直後の即座ポイント反映
   - 繰り返しタスクと通常タスクの混在計算

2. **パフォーマンス改善**
   - 計算速度の測定結果
   - データベースクエリの最適化効果

### 成果物
- [ ] 新しいポイント計算ロジックの実装
- [ ] テストレポート（単体・統合・パフォーマンス）
- [ ] ドキュメント更新（技術仕様・API仕様）
- [ ] 作業ログ

---

## 🔄 スプリント振り返り準備

### Keep（継続すること）
- [実装後に振り返り内容を記録]

### Problem（問題・課題）
- [発生した問題があれば記録]

### Try（次回試すこと）
- [改善案があれば記録]

---

## 🔗 関連ドキュメント

- [POINT-006 機能要件書](../../01-requirements/features/POINT-006_direct-task-points-calculation.md)
- [POINT-005 日付変更時ポイントリセット機能修正](../../01-requirements/features/POINT-005_daily-points-reset-fix.md)
- [ウォーターフォールドキュメント: ポイント管理シーケンス](../../waterfall/シーケンス図/ポイント管理シーケンス.md)
- [データベース定義: テーブル詳細](../../waterfall/データベース定義/テーブル詳細.md)

---

**作成者**: Claude Code Assistant  
**承認者**: User  
**次回スプリント**: sprint-013.md