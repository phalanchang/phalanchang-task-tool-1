# POINT-006: 今日のポイント計算方式をtasksテーブル直接参照に変更

## 📋 作業概要

| ID | 作業内容 | ステータス | 開始日 | 担当者 |
|---|---|---|---|---|
| POINT-006 | 今日のポイント計算方式をtasksテーブル直接参照に変更 | 🔄 実装中 | 2025-07-08 | Claude Code Assistant |

## 🎯 機能概要

### 背景・目的
現在のシステムでは「今日のポイント」の表示に `user_points` テーブルの `daily_points` カラムを使用していますが、以下の課題があります：

1. **データの非同期性**: `daily_points` の更新タイミングとタスク完了タイミングのズレ
2. **複雑な依存関係**: `user_points.daily_points` と `point_history` テーブルの双方向同期
3. **リアルタイム性の欠如**: 即座にポイント反映されない場合がある
4. **データ整合性リスク**: 複数のテーブル間での不整合の可能性

### 改善策
`tasks` テーブルから直接計算することで、シンプルで確実なポイント計算を実現します。

## 📊 現在の仕様 vs 新仕様

| 項目 | 現在の仕様 | 新仕様 |
|------|-----------|--------|
| **データソース** | `user_points.daily_points` | `tasks` テーブル直接集計 |
| **計算タイミング** | タスク完了時に更新 | リクエスト時に動的計算 |
| **データ整合性** | 複数テーブル間で管理 | 単一ソースからの計算 |
| **リアルタイム性** | 非同期更新のため遅延あり | 即座に反映 |
| **複雑さ** | 高（複数テーブルの同期） | 低（単一クエリ） |

## 🔧 技術仕様

### 計算条件
今日のポイントは以下の条件を満たすタスクのポイント合計：

1. **ステータス**: `status = 'completed'`
2. **完了日時**: `DATE(updated_at) = CURRENT_DATE()` （本日完了）
3. **ユーザーID**: 該当ユーザーのタスク（現在は 'default_user'）
4. **ポイント設定**: `points > 0` （ポイントが設定されているタスク）

### SQL計算ロジック
```sql
-- 今日のポイント計算クエリ
SELECT COALESCE(SUM(
  CASE 
    WHEN t.source_task_id IS NOT NULL THEN 
      (SELECT rt.points FROM recurring_tasks rt WHERE rt.id = t.source_task_id)
    ELSE t.points 
  END
), 0) as today_points
FROM tasks t
WHERE t.status = 'completed'
  AND DATE(t.updated_at) = CURRENT_DATE()
  AND t.user_id = 'default_user'; -- 将来的にはパラメータ化
```

### API変更
**エンドポイント**: `GET /api/tasks/user-points`

**変更前のレスポンス**:
```json
{
  "success": true,
  "data": {
    "total_points": 3473,
    "daily_points": 0,  // user_pointsテーブルから取得
    "last_updated": "2025-07-08"
  }
}
```

**変更後のレスポンス**:
```json
{
  "success": true,
  "data": {
    "total_points": 3473,
    "daily_points": 480,  // tasksテーブルから動的計算
    "last_updated": "2025-07-08"
  }
}
```

## 🛠️ 実装計画

### Phase 1: バックエンド修正
1. **新しい計算メソッド作成**: `UserPoints.getTodayPointsFromTasks()`
2. **API応答ロジック変更**: `tasksController.getUserPoints()` の修正
3. **既存ロジック削除**: `daily_points` 依存の除去

### Phase 2: テスト・検証
1. **単体テスト**: 新しい計算ロジックの検証
2. **統合テスト**: API応答の確認
3. **エッジケースチェック**: 日付変更時、ポイント0の場合など

### Phase 3: フロントエンド確認
1. **表示確認**: ポイント表示の動作確認
2. **リアルタイム更新**: タスク完了時の即座反映確認

## 📁 影響するファイル

### バックエンド
- `backend/src/models/Task.js`: 新しい計算メソッド追加
- `backend/src/controllers/tasksController.js`: API応答ロジック変更

### フロントエンド
- 変更不要（APIレスポンス形式は同一のため）

### データベース
- 既存テーブル構造は変更なし
- `user_points.daily_points` は残すが、参照しない

## ⚡ パフォーマンス考慮

### 計算負荷
- **現在**: O(1) - テーブル値の直接取得
- **新方式**: O(n) - 完了タスクの集計計算（nは当日完了タスク数）

### 最適化策
1. **インデックス活用**: `tasks(status, updated_at)` の複合インデックス
2. **キャッシュ戦略**: 頻繁なアクセス時のメモリキャッシュ（将来実装）
3. **クエリ最適化**: 不要なカラム取得の回避

## 🧪 テスト計画

### テストケース
1. **正常系**:
   - 今日完了したタスクのポイント合計が正しく計算される
   - 繰り返しタスクインスタンスのポイントが正しく取得される
   - ポイント0のタスクは計算に含まれない

2. **異常系**:
   - 完了していないタスクは計算に含まれない
   - 昨日以前に完了したタスクは計算に含まれない
   - データベースエラー時の適切なハンドリング

3. **エッジケース**:
   - 今日完了したタスクが0件の場合 → 0ポイント
   - 日付変更直後の動作確認
   - 大量のタスク完了時のパフォーマンス

## 📈 期待される効果

### メリット
1. **データ整合性向上**: 単一ソースからの計算で不整合解消
2. **リアルタイム性**: タスク完了と同時にポイント反映
3. **システム簡素化**: `user_points.daily_points` への依存除去
4. **保守性向上**: ロジックの単純化

### 注意点
1. **パフォーマンス**: 計算負荷の増加（軽微）
2. **移行期間**: 既存 `daily_points` 値との一時的な乖離可能性

## 🔄 ロールバック計画

万一問題が発生した場合の復旧手順：

1. **即座復旧**: API応答ロジックを元の `daily_points` 参照に戻す
2. **データ修復**: 必要に応じて `user_points.daily_points` の再計算
3. **原因調査**: 問題の特定と修正

## 📝 関連ドキュメント

- [POINT-005: 日付変更時ポイントリセット機能修正](./POINT-005_daily-points-reset-fix.md)
- [ウォーターフォールドキュメント: ポイント管理シーケンス](../../waterfall/シーケンス図/ポイント管理シーケンス.md)
- [データベース定義: テーブル詳細](../../waterfall/データベース定義/テーブル詳細.md)

---

**作成日**: 2025年7月8日  
**作成者**: Claude Code Assistant  
**バージョン**: 1.1  
**ステータス**: ✅ 実装完了・レビュー済み