# 要件定義書 - 繰り返しタスクの管理

**ID**: REPEAT-001  
**機能名**: 繰り返しタスクの登録・管理  
**優先度**: Medium  
**作成日**: 2025-06-18  

---

## 📋 概要

### 目的
定期的に発生するタスクを効率的に管理するため、繰り返しタスクの自動生成機能を実装する。

### 背景
- 毎日、毎週、毎月行う定期タスクの手動登録が煩雑
- 繰り返しタスクの管理漏れを防止したい
- 長期的なタスク計画の可視化が必要

---

## 🎯 機能要件

### 基本機能

#### 1. 繰り返しパターンの設定
- [ ] **毎日**: 指定した曜日のみ、平日のみ、毎日
- [ ] **毎週**: 指定した曜日（複数選択可能）
- [ ] **毎月**: 指定した日付、月末、第N曜日
- [ ] **年次**: 指定した月日
- [ ] **カスタム**: N日おき、N週間おき

#### 2. 繰り返しタスクの管理
- [ ] **マスタータスク作成**: 繰り返しの元となるタスク設定
- [ ] **自動生成**: 設定に基づいてタスクを自動生成
- [ ] **生成予定表示**: 今後生成されるタスクの一覧表示
- [ ] **一括編集**: マスタータスク変更時の既存タスク更新

#### 3. 生成タイミング
- [ ] **事前生成**: 指定期間分を事前に生成
- [ ] **リアルタイム生成**: 指定日時に自動生成（cron）
- [ ] **ページアクセス時チェック**: どのページでも画面表示時に本日分タスクの生成チェック
- [ ] **手動生成**: ユーザーが任意のタイミングで生成

#### 4. デイリータスク表示機能
- [ ] **専用表示機能**: 毎日実施するタスクのみを表示
- [ ] **タブ切り替え**: 「すべてのタスク」「デイリータスク」のタブ切り替え
- [ ] **当日分フィルタ**: デイリータスクは当日分のみ表示

---

## 🔧 技術仕様

### データベース設計

#### recurring_tasks テーブル（マスタータスク）
```sql
CREATE TABLE recurring_tasks (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  priority ENUM('low', 'medium', 'high') DEFAULT 'medium',
  pattern_type ENUM('daily', 'weekly', 'monthly', 'yearly', 'custom'),
  pattern_config JSON, -- 繰り返し設定の詳細
  start_date DATE NOT NULL,
  end_date DATE, -- NULL の場合は無期限
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### pattern_config JSON構造例
```json
{
  "daily": {
    "interval": 1, // 1日おき
    "weekdays": [1,2,3,4,5] // 平日のみ（1=月, 7=日）
  },
  "weekly": {
    "interval": 1, // 1週間おき
    "weekdays": [1,3,5] // 月水金
  },
  "monthly": {
    "type": "date", // "date" | "weekday"
    "date": 15, // 毎月15日
    "weekday": {"week": 2, "day": 1} // 第2月曜日
  }
}
```

#### task_instances テーブル（生成されたタスク）
```sql
CREATE TABLE task_instances (
  id INT AUTO_INCREMENT PRIMARY KEY,
  recurring_task_id INT,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  priority ENUM('low', 'medium', 'high'),
  status ENUM('pending', 'completed') DEFAULT 'pending',
  scheduled_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (recurring_task_id) REFERENCES recurring_tasks(id) ON DELETE CASCADE
);
```

### API設計

#### 繰り返しタスク管理API
```
GET    /api/recurring-tasks         # 繰り返しタスク一覧
POST   /api/recurring-tasks         # 繰り返しタスク作成
GET    /api/recurring-tasks/:id     # 繰り返しタスク詳細
PUT    /api/recurring-tasks/:id     # 繰り返しタスク更新
DELETE /api/recurring-tasks/:id     # 繰り返しタスク削除

POST   /api/recurring-tasks/:id/generate    # 手動でタスク生成
GET    /api/recurring-tasks/:id/preview     # 生成予定タスク一覧
```

#### タスクインスタンス管理API
```
GET    /api/task-instances              # 生成されたタスク一覧
GET    /api/task-instances/daily        # デイリータスク（本日分）のみ取得
PUT    /api/task-instances/:id          # 個別タスクの更新
DELETE /api/task-instances/:id          # 個別タスクの削除

POST   /api/task-instances/check-today  # 本日分タスク生成チェック＆作成
```

---

## 🎨 UI/UX設計

### 画面構成

#### 1. 繰り返しタスク作成画面
```
┌─────────────────────────────────────┐
│ 📋 繰り返しタスクの作成              │
├─────────────────────────────────────┤
│ タスク名: [                      ] │
│ 説明:     [                      ] │
│ 優先度:   [中] ▼                   │
│                                     │
│ 繰り返し設定:                       │
│ ( ) 毎日   ( ) 毎週   ( ) 毎月      │
│ [詳細設定...]                       │
│                                     │
│ 期間設定:                           │
│ 開始日: [2025-06-18]               │
│ 終了日: [無期限 ✓] [2025-12-31]   │
│                                     │
│ [プレビュー]  [保存]  [キャンセル]   │
└─────────────────────────────────────┘
```

#### 2. 繰り返しタスク一覧画面
```
┌─────────────────────────────────────┐
│ 📋 繰り返しタスク管理                │
├─────────────────────────────────────┤
│ [新規作成]                          │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 📝 週次レポート作成 [毎週金曜]   │ │
│ │ 🟠 中優先度 | アクティブ        │ │
│ │ [編集] [無効化] [プレビュー]     │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 💊 薬の補充 [毎月1日]           │ │
│ │ 🔴 高優先度 | アクティブ        │ │
│ │ [編集] [無効化] [プレビュー]     │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### 3. タスク一覧画面（タブ切り替え）
```
┌─────────────────────────────────────┐
│ 📋 タスク管理                        │
├─────────────────────────────────────┤
│ [すべてのタスク] [デイリータスク]    │
│                                     │
│ ■ すべてのタスクタブの場合:          │
│ 通常のタスク一覧（既存機能）         │
│                                     │
│ ■ デイリータスクタブの場合:          │
│ ┌─────────────────────────────────┐ │
│ │ ☀️ 今日のデイリータスク           │ │
│ │ 2025-06-18 (火)                 │ │
│ ├─────────────────────────────────┤ │
│ │ ✅ 朝の運動 [完了]              │ │
│ │ ⏳ メール確認 [未完了]          │ │
│ │ ⏳ 日報作成 [未完了]            │ │
│ │ ⏳ デスク整理 [未完了]          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 完了: 1/4 タスク                    │
└─────────────────────────────────────┘
```

#### 4. 生成予定プレビュー画面
```
┌─────────────────────────────────────┐
│ 📅 生成予定タスク - 週次レポート作成  │
├─────────────────────────────────────┤
│ 今後30日間の生成予定:                │
│                                     │
│ 📋 2025-06-20 (金) - 週次レポート作成│
│ 📋 2025-06-27 (金) - 週次レポート作成│
│ 📋 2025-07-04 (金) - 週次レポート作成│
│ 📋 2025-07-11 (金) - 週次レポート作成│
│                                     │
│ [今すぐ生成] [設定変更] [閉じる]     │
└─────────────────────────────────────┘
```

---

## ⚙️ 実装方針

### Phase 1: 基本機能
- [ ] データベース設計・マイグレーション
- [ ] 基本的な繰り返しパターン（毎日、毎週）
- [ ] マスタータスクのCRUD操作
- [ ] 手動でのタスク生成

### Phase 2: 自動化・表示機能
- [ ] 自動タスク生成（cron job）
- [ ] ページアクセス時の本日分タスク生成チェック機能
- [ ] デイリータスク専用表示（タブ切り替え）
- [ ] 生成予定のプレビュー機能
- [ ] 複雑な繰り返しパターン（毎月、年次）

### Phase 3: 高度な機能
- [ ] 一括編集・一括削除
- [ ] カスタム繰り返しパターン
- [ ] 例外日の設定（祝日スキップなど）
- [ ] 統計・レポート機能

---

## 🧪 テスト要件

### ユニットテスト
- [ ] 繰り返しパターン計算ロジック
- [ ] タスク生成ロジック
- [ ] API エンドポイント

### 統合テスト
- [ ] 繰り返しタスク作成フロー
- [ ] タスク生成・管理フロー
- [ ] UI操作テスト

### パフォーマンステスト
- [ ] 大量タスク生成時の性能
- [ ] データベースクエリ最適化

---

## 🚨 制約・注意事項

### 技術的制約
- タスク生成は最大1年先まで
- 同一日に同じ繰り返しタスクは1つまで
- タイムゾーンは日本時間で固定

### ビジネス的制約
- 無料版では繰り返しタスク作成数に制限
- 過去日のタスクは自動生成しない

### セキュリティ
- ユーザー認証実装後は、ユーザー別の繰り返しタスク管理
- 不正なパターン設定の防止

---

## 📊 成功指標

### 機能指標
- [ ] 繰り返しタスクの作成成功率 > 95%
- [ ] タスク自動生成の正確性 > 99%
- [ ] ページロード時間 < 2秒

### ユーザビリティ指標
- [ ] 繰り返しタスク設定の完了時間 < 2分
- [ ] UI操作エラー率 < 5%

---

## 🔗 関連Issue・ドキュメント

- **GitHub Issue**: （作成予定）
- **API設計書**: docs/API設計書.md（更新予定）
- **データベース設計書**: docs/データベース設計書.md（更新予定）

---

## 📝 備考

### 将来的な拡張案
- AI による繰り返しパターンの提案
- 外部カレンダー（Google Calendar）との連携
- チーム での繰り返しタスク共有
- 繰り返しタスクのテンプレート機能

### 参考システム
- Google Calendar の定期イベント
- Todoist の繰り返しタスク
- Notion の定期テンプレート

---

**作成者**: Claude Code  
**レビュー者**: （未定）  
**承認者**: （未定）